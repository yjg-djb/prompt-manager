# 场景：FastAPI接口性能优化（含Ollama集成场景）

## 核心用途

针对FastAPI接口响应慢、并发能力差等问题，生成针对性优化方案及代码调整建议。

---

## 提示词模板

### 接口现状

- **接口功能**：[描述接口作用]
  - 示例：FastAPI+Ollama文本生成接口、数据查询接口、文件上传接口

- **性能问题**：[描述具体性能瓶颈]
  - 示例：响应时间>3s、并发数超过10后出现超时、CPU/内存占用过高

- **测试环境**：[说明测试条件]
  - 示例：本地测试（CPU）、服务器测试（8核16G）
  - 并发测试工具：Locust/JMeter

- **现有代码片段**：[粘贴核心接口代码]
  - 路由定义、业务逻辑、Ollama调用部分

### 技术栈信息

- **FastAPI版本**：[填写版本号]
  - 示例：0.104.1

- **依赖库版本**：[列出相关依赖]
  - 示例：uvicorn、ollama-python、pydantic等

- **部署方式**：[说明部署模式]
  - uvicorn直接启动 / Gunicorn+uvicorn / Docker部署

- **核心约束**：[说明优化限制]
  - 示例：不能修改Ollama模型、需兼容现有前端请求格式、服务器资源有限（4核8G）

### 期望输出要求

1. **性能瓶颈分析**（明确导致慢/并发差的核心原因）
   - 如：Ollama调用无异步、无缓存机制、数据库查询未优化
2. **针对性优化方案**（分层次给出优化措施）
   - 异步改造、缓存策略、并发控制、资源分配调整
3. **代码调整示例**（给出核心部分的优化后代码）
4. **优化后的预期性能指标**
   - 如：响应时间≤1s、支持并发≥50
5. **性能测试方法及验证步骤**（含测试工具、测试用例）

### 输出格式约束

- 按"瓶颈分析 → 优化方案 → 代码示例 → 预期指标 → 测试验证"的顺序呈现
- 代码用对比形式（原代码 → 优化后代码）
- 优化措施分点列出
- **关键优化点**用加粗标注

---

## 使用示例

```
我的FastAPI+Ollama接口性能不佳，需要优化建议。

【接口现状】
- 接口功能：FastAPI封装Ollama-llama3:8b的文本生成接口
- 性能问题：单次请求响应时间约5s，并发超过5后开始超时
- 测试环境：本地开发机（8核16G，无GPU），使用Locust测试
- 现有代码片段：
```python
@app.post("/api/generate")
def generate(request: GenerateRequest):
    response = ollama.generate(model="llama3:8b", prompt=request.prompt)
    return {"text": response["response"]}
```

【技术栈信息】
- FastAPI版本：0.104.1
- 依赖库版本：uvicorn 0.24.0、ollama 0.1.0、pydantic 2.5.0
- 部署方式：uvicorn直接启动（开发模式）
- 核心约束：服务器资源有限（4核8G），不能更换模型

请分析性能瓶颈并提供优化方案。
```
